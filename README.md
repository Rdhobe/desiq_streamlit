# Desiq

A modern Django application.

## Setup

1. Clone the repository
```bash
git clone <repository-url>
cd desiq.live
```

2. Create a virtual environment and activate it
```bash
python -m venv venv
# On Windows
venv\Scripts\activate
# On macOS/Linux
source venv/bin/activate
```

3. Install dependencies
```bash
pip install -r requirements.txt
```

4. Run migrations
```bash
python manage.py migrate
```

5. Default Admin Credentials
The application comes with a default admin user that is created automatically during migrations:
- Username: admin
- Password: DesiqAdmin123!
- Email: admin@desiq.live

You can use these credentials to log in to the admin interface or create your own superuser:
```bash
python manage.py createsuperuser
```

6. Run the development server
```bash
python manage.py runserver
```

7. Access the application
- Frontend: http://127.0.0.1:8000/
- Admin: http://127.0.0.1:8000/admin/

## Features

- Item management
- Admin interface
- Responsive design 

## Gmail API Setup for Email Sending

To enable the Gmail API for sending emails:

1. Install the required packages:
   ```
   pip install google-auth google-auth-oauthlib google-api-python-client
   ```

2. Create a Google Cloud Project:
   - Go to the [Google Cloud Console](https://console.cloud.google.com/)
   - Create a new project
   - Enable the Gmail API
   - Go to Credentials → Create OAuth client ID → Desktop app
   - Download the credentials file and save it as `credentials.json` in the project root

3. First-time authorization:
   - Run the application with `USE_GMAIL_API=True` environment variable
   - The first time an email is sent, a browser window will open to authorize access
   - Grant permission to send emails
   - The token will be saved for future use

4. Environment variables:
   ```
   USE_GMAIL_API=True
   GMAIL_TOKEN_PATH=/path/to/gmail_token.json
   GMAIL_CREDENTIALS_PATH=/path/to/credentials.json
   ```

## Gmail API Integration for Password Reset

We've improved the Gmail API integration to make it more reliable and easier to set up, particularly for password reset emails. The following enhancements have been implemented:

## Improved OAuth Authentication Flow

- Added fixed port (8080) for redirect URI to ensure consistent authentication
- Enhanced error handling for common OAuth issues like redirect_uri_mismatch
- Added better logging and user-friendly error messages

## Updated Documentation

- Created comprehensive GMAIL_API_SETUP.md with step-by-step instructions
- Added OAUTH_REDIRECT_URI_FIX.md for troubleshooting redirect URI issues
- Updated batch files with better error checking and dependency management

## Setup Process

1. Download OAuth credentials (credentials.json) from Google Cloud Console
2. Run `setup_gmail_api.bat` (Windows) or `python setup_gmail_api.py` (Mac/Linux)
3. Follow the prompts to authenticate with your Google account
4. Update your .env file with the provided settings

## Production Deployment

For Render deployment:
1. Set up locally first to generate the token
2. Copy the token JSON string printed during setup
3. Add it as an environment variable in Render:
   - `GMAIL_TOKEN`: [paste token JSON]
   - `USE_GMAIL_API`: True
   - `RENDER`: True

See GMAIL_API_SETUP.md for more detailed instructions.

## Deployment on Render

This project is configured for deployment on [Render](https://render.com/).

### Django Version Compatibility

This project uses Django 4.2.11 due to compatibility requirements with certain packages:
- django-celery-beat 2.5.0 requires Django < 5.0
- Using Django 4.2.11 (LTS) ensures compatibility with all dependencies
- If upgrading Django in the future, check compatibility with all packages in requirements.txt

### Prerequisites

1. A Render account
2. PostgreSQL database (can be created on Render)
3. OpenAI API key
4. Razorpay API keys (if using payment functionality)

### Environment Variables

The following environment variables need to be set in the Render dashboard:

- `DEBUG`: Set to `False` for production
- `SECRET_KEY`: Django secret key (will be auto-generated by Render if using render.yaml)
- `OPENAI_API_KEY`: Your OpenAI API key
- `RAZORPAY_KEY_ID`: Your Razorpay Key ID
- `RAZORPAY_KEY_SECRET`: Your Razorpay Key Secret
- `DATABASE_URL`: Automatically set if using Render PostgreSQL

### Deployment Steps

#### Option 1: Using render.yaml (Recommended)

1. Fork this repository to your GitHub account
2. Connect your GitHub account to Render
3. Click "New +" and select "Blueprint"
4. Select your forked repository
5. Render will automatically detect the `render.yaml` file and set up the services
6. Set the required environment variables in the Render dashboard
7. Deploy!

#### Option 2: Manual Setup

1. Create a new Web Service in Render
2. Connect your GitHub repository
3. Set the following:
   - Build Command: `./build.sh`
   - Start Command: `gunicorn desiq.wsgi:application`
4. Add the required environment variables
5. Create a PostgreSQL database in Render
6. Deploy!

### Scheduled Tasks

The cron jobs defined in `settings.py` won't work directly on Render. Instead:

1. Create a Cron Job in the Render dashboard
2. Set the schedule (e.g., `0 0 * * *` for daily at midnight)
3. Set the command to: `python manage.py reset_daily_limits`

### Troubleshooting

- Check the logs in the Render dashboard for any errors
- Ensure all environment variables are set correctly
- Make sure the database connection is working properly

For more information, refer to the [Render documentation](https://render.com/docs).

# Social Authentication Setup

We've added social login functionality using Google and GitHub. Here's how to set it up:

## Google OAuth Setup

1. Go to the [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select an existing one
3. Navigate to "APIs & Services" > "Credentials"
4. Click "Create Credentials" > "OAuth client ID"
5. Select "Web application" as the Application type
6. Add a name (e.g., "DesiQ Web Login")
7. Under "Authorized JavaScript origins" add:
   ```
   http://localhost:8000
   https://your-production-domain.com
   ```
8. Under "Authorized redirect URIs" add:
   ```
   http://localhost:8000/social-auth/complete/google-oauth2/
   https://your-production-domain.com/social-auth/complete/google-oauth2/
   ```
9. Click "Create"
10. Note your Client ID and Client Secret
11. Add these credentials to your `.env` file:
   ```
   GOOGLE_OAUTH2_KEY=your_client_id
   GOOGLE_OAUTH2_SECRET=your_client_secret
   ```

## GitHub OAuth Setup

1. Go to [GitHub Developer Settings](https://github.com/settings/developers)
2. Click "New OAuth App"
3. Fill in the application details:
   - Application name: DesiQ
   - Homepage URL: http://localhost:8000/ (or your production URL)
   - Authorization callback URL: http://localhost:8000/social-auth/complete/github/ (or your production URL equivalent)
4. Click "Register application"
5. Generate a new client secret
6. Add these credentials to your `.env` file:
   ```
   GITHUB_KEY=your_github_client_id
   GITHUB_SECRET=your_github_client_secret
   ```

## Testing Social Login

After setting up the OAuth credentials, you should be able to use the social login buttons on the login and registration pages. The system will:

1. Redirect users to the chosen service (Google or GitHub)
2. Ask for permission to access basic profile information
3. Create a new user account if needed, or log in to an existing one
4. Redirect back to the DesiQ dashboard