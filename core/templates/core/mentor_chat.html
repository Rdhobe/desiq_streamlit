{% extends 'core/base.html' %}
{% load static %}

{% block title %}Chat with {{ mentor.name }} - Desiq{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Sidebar for desktop, some elements will be moved for mobile -->
    <div class="chat-sidebar">
        <div class="mentor-profile">
            <div class="mentor-image">
                {% if mentor.image %}
                    <img src="{{ mentor.get_image_url }}" alt="{{ mentor.name }}">
                {% else %}
                    <img src="{% static 'img/avatar.png' %}" alt="{{ mentor.name }}">
                {% endif %}
            </div>
            <h3>{{ mentor.name }}</h3>
            <div class="mentor-type">{{ mentor.get_type_display }}</div>
            {% if mentor.is_premium %}
                <div class="premium-badge">Premium</div>
            {% endif %}
        </div>
        
        <div class="expertise-card">
            <h4>Expertise</h4>
            <div class="expertise-tags" id="expertise-tags" data-expertise="{{ mentor.expertise }}">
                <!-- Tags will be generated by JavaScript -->
            </div>
            <div class="expertise-description">
                <p>{{ mentor.description }}</p>
            </div>
        </div>
        
        <div class="chat-limits desktop-only">
            <h4>Daily Message Limit</h4>
            <div class="limit-progress">
                <div class="progress-bar">
                    <div class="progress" style="width: {% widthratio chat_usage.messages_sent 20 100 %}%"></div>
                </div>
                <div class="limit-text">
                    <span>{{ remaining_messages }} messages left today</span>
                </div>
            </div>
        </div>
        
        <div class="back-link desktop-only">
            <a href="{% url 'core:mentor_list' mentor.type %}">← Back to Mentors</a>
        </div>
    </div>
    
    <div class="chat-main">
        <!-- Mobile layout elements in correct order -->
        <div class="mobile-layout mobile-only">
            <!-- 1. Back to Mentors button at the top -->
            <div class="mobile-back-link">
                <a href="{% url 'core:mentor_list' mentor.type %}">← Back to Mentors</a>
            </div>
            
        </div>
        
        <!-- Desktop chat header (hidden on mobile) -->
        <div class="chat-header desktop-only">
            <h2>Chat with {{ mentor.name }}</h2>
        </div>
        
        <!-- 3. Chat messages -->
        <div class="chat-messages" id="chat-messages">
            {% if chat_history %}
                {% for message in chat_history %}
                    <div class="message {% if message.message_type == 'user' %}user-message{% else %}mentor-message{% endif %}">
                        <div class="message-content">
                            {{ message.message|linebreaksbr|urlize }}
                        </div>
                        <div class="message-time">
                            {{ message.timestamp|time:"H:i" }}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="welcome-message" id="welcome-message">
                    <h3>Welcome to your chat with {{ mentor.name }}</h3>
                    <p>Start the conversation by sending a message related to {{ mentor.expertise }}.</p>
                </div>
            {% endif %}
            
            <!-- Loading indicator -->
            <div class="loading-indicator" style="display: none;">
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="loading-text">{{ mentor.name }} is typing...</div>
            </div>
        </div>
        
        <!-- 4. Mobile-only chat limits after messages -->
        <div class="chat-limits mobile-only">
            <h4>Daily Message Limit</h4>
            <div class="limit-progress">
                <div class="progress-bar">
                    <div class="progress" style="width: {% widthratio chat_usage.messages_sent 20 100 %}%"></div>
                </div>
                <div class="limit-text">
                    <span>{{ remaining_messages }} messages left today</span>
                </div>
            </div>
        </div>
        
        <div class="chat-input">
            <form method="post" id="chat-form">
                {% csrf_token %}
                <div class="input-group">
                    <textarea name="message" id="message" placeholder="Type your message..." {% if not can_send_message %}disabled{% endif %}></textarea>
                    <button type="submit" class="btn-send" {% if not can_send_message %}disabled{% endif %}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
                <!-- Error message for empty submissions -->
                <div class="empty-message-error" style="display: none;">
                    Message cannot be empty. Please type something.
                </div>
                {% if not can_send_message %}
                <div class="limit-reached">
                    You've reached your daily message limit for this mentor. Come back tomorrow or <a href="#">upgrade to premium</a> for more messages.
                </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        width: 100%;
        height: calc(100vh - 70px);
        display: flex;
        background: linear-gradient(
            245deg,
            rgba(255, 255, 255, 1) 8%,
            rgba(255, 239, 246, 1) 40%,
            rgba(234, 218, 242, 1) 67%,
            rgba(210, 182, 227, 1) 82%
        );
        font-family: "Inter", sans-serif;
    }

    .chat-sidebar {
        width: 300px;
        background-color: rgba(255, 255, 255, 0.95);
        border-right: 1px solid #eee;
        padding: 20px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        z-index: 10;
    }

    .mentor-profile {
        text-align: center;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
        position: relative;
    }

    .mentor-image {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        overflow: hidden;
        margin: 0 auto 15px;
        border: 3px solid #e9f0ff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }

    .mentor-image:hover {
        transform: scale(1.05);
    }

    .mentor-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .mentor-profile h3 {
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 5px;
        color: #1b309a;
    }

    .mentor-type {
        font-size: 16px;
        color: #444;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .premium-badge {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        color: #333;
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 12px;
        display: inline-block;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* Expertise Card Styles */
    .expertise-card {
        padding: 20px 0;
        border-bottom: 1px solid #eee;
        margin-bottom: 5px;
    }

    .expertise-card h4 {
        font-size: 16px;
        margin-bottom: 12px;
        color: #333;
        font-weight: 600;
    }

    .expertise-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
    }

    .expertise-tag {
        background: linear-gradient(135deg, rgba(27, 48, 154, 0.1) 0%, rgba(48, 79, 254, 0.1) 100%);
        color: #1b309a;
        font-size: 12px;
        font-weight: 500;
        padding: 6px 12px;
        border-radius: 15px;
        display: inline-block;
        border: 1px solid rgba(27, 48, 154, 0.2);
    }

    .expertise-description {
        font-size: 14px;
        color: #555;
        line-height: 1.5;
        margin-top: 10px;
        background-color: rgba(245, 247, 250, 0.6);
        padding: 12px;
        border-radius: 8px;
        border-left: 3px solid #1b309a;
    }

    .expertise-description p {
        margin: 0;
    }

    .chat-limits {
        padding: 20px 0;
        border-bottom: 1px solid #eee;
    }

    .chat-limits h4 {
        font-size: 16px;
        margin-bottom: 10px;
        color: #333;
        font-weight: 600;
    }

    .limit-progress {
        margin-bottom: 10px;
    }

    .progress-bar {
        height: 8px;
        background-color: #eee;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress {
        height: 100%;
        background: linear-gradient(90deg, #1b309a 0%, #7367f0 100%);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .limit-text {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
        text-align: right;
    }

    .back-link, .mobile-back-link {
        padding-top: 10px;
        padding-bottom: 10px;
    }

    .back-link a, .mobile-back-link a {
        color: #1b309a;
        text-decoration: none;
        font-size: 14px;
        display: flex;
        align-items: center;
        transition: transform 0.2s ease;
        font-weight: 500;
    }

    .back-link a:hover, .mobile-back-link a:hover {
        text-decoration: none;
        transform: translateX(-3px);
        color: #142270;
    }

    .mobile-back-link {
        padding: 15px;
        background-color: rgba(255, 255, 255, 0.95);
        border-bottom: 1px solid #eee;
    }

    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: rgba(255, 255, 255, 0.8);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border-radius: 0 12px 12px 0;
    }

    .chat-header, .mobile-chat-header {
        padding: 18px 25px;
        border-bottom: 1px solid #eee;
        background-color: rgba(255, 255, 255, 0.95);
    }

    .chat-header h2, .mobile-chat-header h2 {
        font-size: 20px;
        font-weight: 600;
        color: #1b309a;
        margin: 0;
    }

    .mobile-layout {
        display: none; /* Hidden by default, shown on mobile */
    }

    .messages {
        padding: 10px 20px;
    }

    .alert {
        padding: 10px 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        font-size: 14px;
    }

    .alert-success {
        background-color: #d1e7dd;
        color: #0f5132;
        border: 1px solid #badbcc;
    }

    .alert-warning {
        background-color: #fff3cd;
        color: #664d03;
        border: 1px solid #ffecb5;
    }

    .alert-error, .alert-danger {
        background-color: #f8d7da;
        color: #842029;
        border: 1px solid #f5c2c7;
    }

    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        background-color: rgba(245, 247, 250, 0.7);
        background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%231b309a' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
    }

    .message {
        max-width: 75%;
        margin-bottom: 20px;
        position: relative;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .user-message {
        align-self: flex-end;
        background: linear-gradient(135deg, #1b309a 0%, #304ffe 100%);
        color: white;
        border-radius: 18px 18px 0 18px;
        box-shadow: 0 2px 8px rgba(27, 48, 154, 0.2);
    }

    .mentor-message {
        align-self: flex-start;
        background-color: white;
        color: #333;
        border-radius: 18px 18px 18px 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border-left: 3px solid #1b309a;
    }

    .message-content {
        padding: 15px 18px;
        line-height: 1.5;
        font-size: 15px;
    }

    /* Markdown-style formatting styles */
    .mentor-message .message-content strong {
        font-weight: 600;
        color: #1b309a;
    }

    .mentor-message .message-content em {
        font-style: italic;
        color: #555;
    }

    .mentor-message .message-content .chat-heading {
        font-size: 17px;
        font-weight: 600;
        color: #1b309a;
        margin: 15px 0 8px;
        padding-bottom: 5px;
        border-bottom: 1px solid rgba(27, 48, 154, 0.2);
    }

    .mentor-message .message-content h3:first-child {
        margin-top: 0;
    }

    .mentor-message .message-content .chat-heading + * {
        margin-top: 5px;
    }

    /* Style for titles with asterisks like **Self-Assessment** */
    .mentor-message .message-content strong:first-child {
        display: block;
        font-size: 18px;
        margin-bottom: 8px;
        color: #304ffe;
        padding-left: 5px;
        border-left: 3px solid #304ffe;
    }

    .mentor-message .message-content {
        color: #444;
    }

    .mentor-message .message-content a {
        color: #1b309a;
        text-decoration: underline;
        font-weight: 500;
    }

    .mentor-message .message-content a:hover {
        color: #304ffe;
    }

    .message-time {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 5px;
        text-align: right;
        padding: 0 8px;
    }

    .welcome-message {
        text-align: center;
        padding: 40px 20px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        margin: auto;
        max-width: 600px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(27, 48, 154, 0.1);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .welcome-message.hidden {
        opacity: 0;
        transform: translateY(-20px);
        pointer-events: none;
        position: absolute;
    }

    .welcome-message h3 {
        font-size: 24px;
        color: #1b309a;
        margin-bottom: 15px;
        font-weight: 600;
    }

    .welcome-message p {
        font-size: 16px;
        color: #666;
        line-height: 1.6;
    }

    .chat-input {
        padding: 20px;
        background-color: rgba(255, 255, 255, 0.95);
        border-top: 1px solid #eee;
        border-radius: 0 0 12px 0;
    }

    .input-group {
        display: flex;
        align-items: center;
        background: white;
        border-radius: 24px;
        padding: 5px 5px 5px 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: box-shadow 0.3s ease, transform 0.2s ease;
        border: 1px solid #eee;
        position: relative;
    }

    .input-group:focus-within {
        box-shadow: 0 2px 15px rgba(27, 48, 154, 0.15);
        border-color: #d0d9ff;
        transform: translateY(-2px);
    }

    textarea {
        flex: 1;
        border: none;
        border-radius: 20px;
        padding: 12px 0;
        font-size: 15px;
        resize: none;
        height: 24px;
        font-family: inherit;
        background-color: transparent;
        transition: height 0.2s ease;
    }

    textarea:focus {
        outline: none;
    }

    textarea:disabled {
        background-color: #f9f9f9;
        cursor: not-allowed;
    }

    .btn-send {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #1b309a 0%, #304ffe 100%);
        color: white;
        border: none;
        margin-left: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .btn-send:hover {
        background: linear-gradient(135deg, #142270 0%, #1a237e 100%);
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-send:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: scale(1);
        box-shadow: none;
    }

    .limit-reached {
        margin-top: 15px;
        text-align: center;
        font-size: 14px;
        color: #d63384;
        background-color: rgba(214, 51, 132, 0.1);
        padding: 10px 15px;
        border-radius: 8px;
    }

    .limit-reached a {
        color: #1b309a;
        font-weight: 600;
        text-decoration: none;
    }

    .limit-reached a:hover {
        text-decoration: underline;
    }

    /* Empty message error styling */
    .empty-message-error {
        color: #dc3545;
        font-size: 13px;
        margin-top: 8px;
        text-align: center;
        animation: fadeIn 0.3s ease-in-out;
        background-color: rgba(220, 53, 69, 0.1);
        padding: 8px 12px;
        border-radius: 8px;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Loading indicator styles */
    .loading-indicator {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin: 10px 0;
        opacity: 0.8;
    }
    
    .typing-indicator {
        display: flex;
        padding: 12px 18px;
        background-color: white;
        border-radius: 18px 18px 18px 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .typing-indicator span {
        width: 8px;
        height: 8px;
        margin: 0 2px;
        background-color: #1b309a;
        border-radius: 50%;
        display: inline-block;
        opacity: 0.4;
    }
    
    .typing-indicator span:nth-child(1) {
        animation: typing 1.2s infinite ease-in-out;
        animation-delay: 0s;
    }
    
    .typing-indicator span:nth-child(2) {
        animation: typing 1.2s infinite ease-in-out;
        animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
        animation: typing 1.2s infinite ease-in-out;
        animation-delay: 0.4s;
    }
    
    .loading-text {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
        margin-left: 10px;
        font-style: italic;
    }
    
    @keyframes typing {
        0% { transform: translateY(0); opacity: 0.4; }
        50% { transform: translateY(-5px); opacity: 1; }
        100% { transform: translateY(0); opacity: 0.4; }
    }

    /* Mobile/Desktop visibility classes */
    .mobile-only {
        display: none;
    }
    
    .desktop-only {
        display: block;
    }

    @media (max-width: 768px) {
        .mobile-only {
            display: block;
        }
        
        .desktop-only {
            display: none;
        }
        
        .mobile-layout {
            display: block;
            width: 100%;
            z-index: 10;
        }
        
        .chat-container {
            flex-direction: column;
            height: auto;
        }

        .chat-sidebar {
            width: 100%;
            border-right: none;
            border-bottom: 1px solid #eee;
            order: 3; /* Move sidebar down */
            padding: 10px;
        }

        .chat-main {
            height: calc(100vh - 180px);
            order: 1; /* Move main content up */
            display: flex;
            flex-direction: column;
            border-radius: 0;
        }

        .mentor-profile {
            display: flex;
            align-items: center;
            text-align: left;
            padding-bottom: 15px;
        }

        .mentor-image {
            margin: 0 15px 0 0;
            width: 60px;
            height: 60px;
        }
        
        .expertise-card {
            padding: 15px 10px;
        }
        
        .expertise-tags {
            margin-bottom: 10px;
        }
        
        .expertise-tag {
            font-size: 11px;
            padding: 4px 10px;
        }
        
        .expertise-description {
            padding: 10px;
            font-size: 13px;
        }

        .chat-limits {
            padding: 15px 10px;
            border-bottom: none;
            border-top: 1px solid #eee;
            margin-top: 0;
            order: 3; /* Place after messages */
        }
        
        .message {
            max-width: 85%;
        }
        
        /* Adjust chat messages area */
        .chat-messages {
            padding: 15px;
            max-height: calc(100vh - 250px);
            order: 2; /* Place after header */
        }
        
        /* Make chat input appear at the bottom */
        .chat-input {
            order: 4; /* Place at the bottom */
            border-radius: 0;
        }
        
        /* Mobile header styling */
        .mobile-chat-header {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .mobile-chat-header h2 {
            font-size: 18px;
        }
        
        /* Mobile back link styling */
        .mobile-back-link {
            padding: 10px 15px;
            border-bottom: none;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Generate expertise tags
        const generateExpertiseTags = function() {
            const expertiseTagsContainer = document.getElementById('expertise-tags');
            if (expertiseTagsContainer) {
                const expertiseString = expertiseTagsContainer.getAttribute('data-expertise');
                if (expertiseString) {
                    // Split by comma and trim whitespace
                    const expertiseList = expertiseString.split(',').map(item => item.trim());
                    
                    // Create tags
                    expertiseTagsContainer.innerHTML = '';
                    expertiseList.forEach(expertise => {
                        const tagSpan = document.createElement('span');
                        tagSpan.className = 'expertise-tag';
                        tagSpan.textContent = expertise;
                        expertiseTagsContainer.appendChild(tagSpan);
                    });
                }
            }
        };
    
        // Set mentor image in header for mobile view
        const setMentorImage = function() {
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                const chatHeader = document.querySelector('.mobile-chat-header');
                {% if mentor.image %}
                    chatHeader.style.setProperty('--mentor-image-url', 'url("{{ mentor.get_image_url }}")');
                    chatHeader.querySelector('h2').style.paddingLeft = '40px';
                {% else %}
                    chatHeader.style.setProperty('--mentor-image-url', 'url("{% static "img/avatar.png" %}")');
                {% endif %}
            }
        };
        
        // Fix for mobile viewport height (especially for iOS Safari)
        const setVhProperty = function() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        };
        
        // Scroll to bottom of messages
        const scrollToBottom = function() {
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        };
        
        // Hide welcome message
        const hideWelcomeMessage = function() {
            const welcomeMessage = document.getElementById('welcome-message');
            if (welcomeMessage) {
                welcomeMessage.classList.add('hidden');
                // Remove it from DOM after animation completes
                setTimeout(() => {
                    if (welcomeMessage.parentNode) {
                        welcomeMessage.parentNode.removeChild(welcomeMessage);
                    }
                }, 300);
            }
        };
        
        // Make textarea auto-expand
        const textarea = document.getElementById('message');
        if (textarea) {
            const adjustHeight = function() {
                textarea.style.height = 'auto';
                const newHeight = Math.min(textarea.scrollHeight, 120);
                textarea.style.height = newHeight + 'px';
            };
            
            textarea.addEventListener('input', adjustHeight);
            textarea.addEventListener('focus', adjustHeight);
            
            // Add event listener for Enter key to send message
            textarea.addEventListener('keydown', function(e) {
                // Check if Enter key is pressed without Shift key
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // Prevent default behavior (new line)
                    
                    // Submit the form
                    const form = document.getElementById('chat-form');
                    if (form) {
                        const submitEvent = new Event('submit', {
                            bubbles: true,
                            cancelable: true,
                        });
                        form.dispatchEvent(submitEvent);
                    }
                }
                // Allow Shift+Enter for new line (default behavior)
            });
        }
        
        // Handle formatting in mentor messages
        const formatMentorMessages = function() {
            const mentorMessages = document.querySelectorAll('.mentor-message .message-content');
            mentorMessages.forEach(message => {
                // Convert URLs to clickable links
                let text = message.innerHTML;
                
                // Process markdown-style formatting
                text = formatMarkdownText(text);
                
                message.innerHTML = text;
            });
        };

        // Function to format markdown-style text
        const formatMarkdownText = function(text) {
            // Handle line breaks first
            text = text.replace(/\n/g, '<br>');
            
            // Format headers (### Heading)
            text = text.replace(/###\s+([^\n<]+)(<br>|$)/g, '<h3 class="chat-heading">$1</h3>$2');
            
            // Format bold text (**text**)
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Format italics (*text*)
            text = text.replace(/\*([^*<]+)\*/g, '<em>$1</em>');
            
            // Format URLs
            text = text.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>');
            
            return text;
        };
        
        // Form submission handler
        const form = document.getElementById('chat-form');
        const loadingIndicator = document.querySelector('.loading-indicator');
        const emptyMessageError = document.querySelector('.empty-message-error');
        
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const message = textarea.value.trim();
                
                // Hide any previous error message
                emptyMessageError.style.display = 'none';
                
                if (!message) {
                    // Show empty message error
                    emptyMessageError.style.display = 'block';
                    // Add shake animation to textarea for visual feedback
                    textarea.classList.add('shake-error');
                    setTimeout(() => {
                        textarea.classList.remove('shake-error');
                    }, 500);
                    // Focus the textarea
                    textarea.focus();
                    return; // Stop form submission
                }
                
                // Hide welcome message when first message is sent
                hideWelcomeMessage();
                
                // If we get here, message is not empty
                // Add user message immediately to UI for better UX
                const chatMessages = document.getElementById('chat-messages');
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'message user-message';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = message;
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                const now = new Date();
                timeDiv.textContent = now.getHours().toString().padStart(2, '0') + ':' + 
                                     now.getMinutes().toString().padStart(2, '0');
                
                userMessageDiv.appendChild(contentDiv);
                userMessageDiv.appendChild(timeDiv);
                chatMessages.appendChild(userMessageDiv);
                
                // Create FormData with the message before clearing input
                const formData = new FormData();
                formData.append('message', message);
                formData.append('csrfmiddlewaretoken', form.querySelector('[name="csrfmiddlewaretoken"]').value);
                
                // Clear input and reset height
                textarea.value = '';
                textarea.style.height = 'auto';
                
                // Scroll to bottom
                scrollToBottom();
                
                // Show loading indicator
                loadingIndicator.style.display = 'flex';
                scrollToBottom();
                
                // Disable inputs while loading
                textarea.disabled = true;
                form.querySelector('button[type="submit"]').disabled = true;
                
                // Now submit the form with our prepared FormData
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // Hide loading indicator
                    loadingIndicator.style.display = 'none';
                    
                    // Re-enable inputs
                    textarea.disabled = false;
                    form.querySelector('button[type="submit"]').disabled = false;
                    textarea.focus();
                    
                    if (data.success) {
                        // Add mentor response
                        const mentorMessageDiv = document.createElement('div');
                        mentorMessageDiv.className = 'message mentor-message';
                        
                        const mentorContentDiv = document.createElement('div');
                        mentorContentDiv.className = 'message-content';
                        
                        // Process the response to handle formatting
                        const formattedResponse = formatMarkdownText(data.response);
                        
                        mentorContentDiv.innerHTML = formattedResponse;
                        
                        const mentorTimeDiv = document.createElement('div');
                        mentorTimeDiv.className = 'message-time';
                        const responseTime = new Date();
                        mentorTimeDiv.textContent = responseTime.getHours().toString().padStart(2, '0') + ':' + 
                                               responseTime.getMinutes().toString().padStart(2, '0');
                        
                        mentorMessageDiv.appendChild(mentorContentDiv);
                        mentorMessageDiv.appendChild(mentorTimeDiv);
                        chatMessages.appendChild(mentorMessageDiv);
                        
                        // Update remaining messages
                        if (data.remaining_messages !== undefined) {
                            const remainingMessagesSpan = document.querySelector('.limit-text span');
                            if (remainingMessagesSpan) {
                                remainingMessagesSpan.textContent = data.remaining_messages + ' messages left today';
                            }
                            
                            // Update progress bar
                            const progressBar = document.querySelector('.progress');
                            if (progressBar && data.messages_sent !== undefined) {
                                const percentage = (data.messages_sent / 20) * 100;
                                progressBar.style.width = percentage + '%';
                            }
                        }
                        
                        // Scroll to show new message
                        scrollToBottom();
                    } else {
                        // Handle error
                        console.error('Error sending message:', data.error);
                        // Show error message below textarea
                        emptyMessageError.textContent = data.error || 'An error occurred. Please try again.';
                        emptyMessageError.style.display = 'block';
                    }
                })
                .catch(error => {
                    // Hide loading indicator and re-enable inputs on error
                    loadingIndicator.style.display = 'none';
                    textarea.disabled = false;
                    form.querySelector('button[type="submit"]').disabled = false;
                    
                    console.error('Error:', error);
                    alert('An error occurred while sending your message. Please try again.');
                });
            });
            
            // Add CSS for the shake animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                    20%, 40%, 60%, 80% { transform: translateX(5px); }
                }
                .shake-error {
                    animation: shake 0.5s;
                    border-color: #dc3545 !important;
                }
            `;
            document.head.appendChild(style);
            
            // Clear error message when user starts typing
            if (textarea) {
                textarea.addEventListener('input', function() {
                    emptyMessageError.style.display = 'none';
                });
            }
        }
        
        // Check if there are already messages in the chat and hide welcome message if needed
        const checkForExistingMessages = function() {
            const messages = document.querySelectorAll('.message');
            if (messages.length > 0) {
                hideWelcomeMessage();
            }
        };
        
        // Initialize
        generateExpertiseTags();
        formatMentorMessages();
        setVhProperty();
        setMentorImage();
        scrollToBottom();
        checkForExistingMessages();
        
        // Add event listeners
        window.addEventListener('resize', function() {
            setVhProperty();
            scrollToBottom();
        });
        
        // Focus input on page load
        if (textarea && !textarea.disabled) {
            setTimeout(() => {
                textarea.focus();
            }, 500);
        }
        
        // Fix for iOS keyboard appearing and disappearing
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
            window.addEventListener('focusin', function() {
                // Wait a moment for the keyboard to fully appear
                setTimeout(scrollToBottom, 300);
            });
            window.addEventListener('focusout', function() {
                // Wait for keyboard to disappear
                setTimeout(scrollToBottom, 300);
            });
        }
    });
</script>
{% endblock %} 